<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>StudentHub Admin â€“ Approved Submissions</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/styles/styles.css">

  <style>
    /* =========================================
   STUDENTHUB ADMIN â€“ APPROVED (FINAL)
   Uses ONLY global theme variables
========================================= */

    .admin-shell {
      min-height: 100vh;
      background: var(--bg);
    }

    .admin-main {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1.5rem 2.5rem;
    }

    /* ===== CARD ===== */

    .admin-card {
      background: var(--card);
      border: 1px solid var(--card-2);
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 12px 28px rgba(0, 0, 0, .12);
    }

    /* ===== HEADINGS ===== */

    h1 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
    }

    .subtitle {
      color: var(--muted);
      margin-bottom: 1rem;
    }

    /* ===== TABLE ===== */

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }

    .admin-table th,
    .admin-table td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid var(--card-2);
      color: var(--text);
      vertical-align: top;
    }

    .admin-table th {
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--muted);
    }

    /* ===== CELLS ===== */

    .title-cell {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .meta-line {
      color: var(--muted);
      font-size: 0.85rem;
      margin-bottom: 6px;
    }

    .desc {
      color: var(--muted);
      white-space: pre-wrap;
      max-width: 600px;
      word-break: break-word;
    }

    /* ===== STATUS ===== */

    .status-pill {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 700;
    }

    .status-approved {
      background: #dcfce7;
      color: #166534;
    }

    /* ===== BUTTONS ===== */

    .btn-small {
      border: none;
      border-radius: 999px;
      padding: 0.4rem 0.8rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-delete {
      background: var(--danger);
      color: #fff;
    }

    .btn-publish {
      background: var(--success);
      color: #fff;
      margin-right: 6px;
    }

    /* ===== INPUT ===== */

    .input-coins {
      width: 72px;
      padding: 0.35rem;
      border-radius: 8px;
      border: 1px solid var(--card-2);
      background: var(--card);
      color: var(--text);
    }

    /* ===== STATUS TEXT ===== */

    #approved-status {
      margin-top: 0.6rem;
      color: var(--muted);
    }

    /* ===== MOBILE ===== */

    @media (max-width:900px) {

      .admin-table th:nth-child(4),
      .admin-table td:nth-child(4) {
        display: none;
      }
    }
  </style>

</head>

<body>
  <div class="admin-shell">
    <!-- ================= ADMIN NAVBAR (GLOBAL) ================= -->
    <nav class="admin-navbar">
      <div class="admin-navbar-inner">

        <div class="admin-brand">StudentHub Admin</div>

        <div class="admin-nav">
          <a href="/admin.html">Upload</a>
          <a href="/admin-materials.html">Materials</a>
          <a href="/admin-submissions.html">Submissions</a>
          <a href="/admin-approved.html" class="active">Approved</a>
          <a href="/admin-withdrawals.html">Withdrawals</a>
          <a href="/admin-requests.html">ðŸ“© Requests</a>
          <a href="/admin/admin-quiz.html">Generate Quiz</a>
          <a href="/admin/admin-quizzes.html">All Quizzes</a>
        </div>

        <div class="admin-actions">
          <a href="/" class="admin-view-link">View site</a>
          <button id="theme-toggle" class="theme-toggle-btn">ðŸŒ™</button>
        </div>

      </div>
    </nav>

    <main class="admin-main">
      <div class="admin-card">
        <h1>Approved Submissions</h1>
        <p class="subtitle">All submissions that have been approved by admins. From here you can review, remove, or
          publish them to the library (manual step).</p>

        <div style="overflow-x:auto;">
          <table class="admin-table" id="approved-table">
            <thead>
              <tr>
                <th style="min-width:220px;">Title &amp; Description</th>
                <th style="min-width:220px;">User</th>
                <th style="min-width:120px;">Submitted</th>
                <th>PDF</th>
                <th>Type</th>
                <th>Exam</th>
                <th>Subject</th>
                <th>Year</th>
                <th>Status</th>
                <th style="min-width:160px;">Actions</th>
              </tr>
            </thead>
            <tbody id="approved-table-body">
              <tr>
                <td colspan="10">Loading approved submissionsâ€¦</td>
              </tr>
            </tbody>
          </table>
        </div>

        <p id="approved-status">Loading approved submissionsâ€¦</p>
      </div>
    </main>
  </div>

  <script>

    /* Load approved submissions */
    async function loadApproved() {
      const tbody = document.getElementById("approved-table-body");
      const statusEl = document.getElementById("approved-status");
      tbody.innerHTML = '<tr><td colspan="10">Loading approved submissionsâ€¦</td></tr>';
      statusEl.textContent = "Loading approved submissionsâ€¦";

      try {
        const res = await fetch('/api/admin/submissions?status=approved', { credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) throw new Error(data.message || 'Failed to load');

        const list = data.submissions || [];
        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="10">No approved submissions.</td></tr>';
          statusEl.textContent = "No approved submissions.";
          return;
        }

        tbody.innerHTML = "";
        list.forEach(raw => {
          // âœ… Normalize backend fields (IMPORTANT)
          const s = {
            ...raw,
            id: raw.id || raw._id || "",
            fileUrl: raw.fileUrl || raw.pdfUrl || raw.file || "",
          };

          const submittedAt = s.createdAt
            ? new Date(s.createdAt).toLocaleString()
            : "â€”";

          const pdfLink = s.fileUrl
            ? `<a href="${s.fileUrl}" target="_blank" rel="noopener">Open PDF</a>`
            : "â€”";

          const titleHtml = `
    <div class="title-cell">${escapeHtml(s.title || "Untitled")}</div>
    <div class="meta-line">
      ${escapeHtml(s.type || "")}
      ${s.type ? " â€¢ " : ""}
      ${escapeHtml(s.userEmail || "")}
    </div>
    <div class="desc">${escapeHtml(s.description || "")}</div>
  `;

          const row = document.createElement("tr");
          row.innerHTML = `
    <td>${titleHtml}</td>
    <td>${escapeHtml(s.userEmail || "â€”")}</td>
    <td>${escapeHtml(submittedAt)}</td>
    <td>${pdfLink}</td>
    <td>${escapeHtml(s.type === "ebook" ? "E-Book" : s.type === "questionPaper" ? "Question Paper" : "PDF")}</td>
    <td>${escapeHtml(s.exam || "â€”")}</td>
    <td>${escapeHtml(s.subject || "â€”")}</td>
    <td>${escapeHtml(s.year || "â€”")}</td>
    <td>
      <span class="status-pill status-approved">approved</span>
    </td>
    <td>
      <button
        class="btn-publish btn-small"
        data-id="${s.id}"
        data-action="publish"
      >
        Publish
      </button>

      <button
        class="btn-delete btn-small"
        data-id="${s.id}"
        data-action="remove"
      >
        Remove
      </button>
    </td>
  `;

          tbody.appendChild(row);
        });

        statusEl.textContent = `${list.length} approved submission(s) loaded.`;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="10" style="color:#b91c1c;">Error loading approved submissions.</td></tr>';
        statusEl.textContent = "Error loading approved submissions.";
      }
    }

    /* Event delegation for actions */
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if (!id || !action) return;

      if (action === 'publish') {
        // This UI tries to publish the approved submission to ebooks.
        // NOTE: Your server currently doesn't have a publish endpoint by default.
        // If you have implemented a server endpoint to publish, call it here.
        // Otherwise show a helpful message.
        const confirmPublish = confirm("Publish this approved submission to the library (create an ebook)?");
        if (!confirmPublish) return;

        // If you implement server route /api/user-submissions/:id/publish, replace below with that call.
        // For now just notify the admin to publish manually.
        alert("Publish functionality requires a server endpoint. If you want, I can add a /api/user-submissions/:id/publish endpoint to the server-side code. Do you want me to add it?");
      }

      if (action === 'remove') {
        const reason = prompt("Reason for removal (optional):", "removed-from-approved") || "";
        if (!confirm("Remove this approved submission permanently? This will delete it from submissions.")) return;

        try {
          const res = await fetch(`/api/user-submissions/${id}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ reason })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok) throw new Error(data.message || 'Failed to remove');
          loadApproved();
        } catch (err) {
          alert("Failed to remove: " + (err.message || err));
          console.error(err);
        }
      }
    });

    /* small helper to escape user strings to prevent injection when injecting into innerHTML */
    function escapeHtml(s) {
      if (!s) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;')
        .replaceAll("\n", '<br/>');
    }

  </script>
  <script src="/admin-theme.js"></script>
  <script src="admin.js" defer></script>

</body>

</html>