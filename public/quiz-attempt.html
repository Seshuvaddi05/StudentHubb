<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Attempt Quiz | StudentHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- GLOBAL THEME -->
  <link rel="stylesheet" href="/styles/styles.css" />

  <style>
    /* =========================================
   GLOBAL
========================================= */

    body {
      margin: 0;
      font-family: system-ui;
      background: var(--bg);
      color: var(--text);
    }

    /* =========================================
   LAYOUT
========================================= */

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* =========================================
   SIDEBAR
========================================= */

    .sidebar {
      width: 240px;
      background: var(--card);
      border-right: 1px solid var(--card-2);
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar h3 {
      margin-top: 0;
      color: var(--primary);
    }

    /* question grid */

    .q-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }

    .q-btn {
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      background: var(--card-2);
      color: var(--text);
      transition: .2s;
    }

    .q-btn:hover {
      transform: translateY(-1px);
    }

    /* states */

    .q-btn.active {
      background: var(--primary);
      color: var(--bg);
    }

    .q-btn.answered {
      background: var(--success);
      color: var(--bg);
    }

    .q-btn.review {
      background: var(--danger);
      color: var(--bg);
    }

    /* =========================================
   MAIN
========================================= */

    .main {
      flex: 1;
      padding: 30px 50px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      font-size: 22px;
      font-weight: 800;
      color: var(--primary);
    }

    .right-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* =========================================
   BUTTONS (THEME SAFE)
========================================= */

    .btn {
      padding: 9px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: .15s;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn-primary {
      background: var(--primary);
      color: var(--bg);
    }

    .btn-danger {
      background: var(--danger);
      color: var(--bg);
    }

    .btn-accent {
      background: var(--accent);
      color: #fff;
    }

    /* =========================================
   TIMER
========================================= */

    .timer {
      background: var(--primary);
      color: var(--bg);
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: bold;
      min-width: 80px;
      text-align: center;
    }

    .timer.danger {
      background: var(--danger);
      color: #fff;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% {
        opacity: .5
      }
    }

    /* =========================================
   PROGRESS BAR
========================================= */

    .progress {
      height: 6px;
      background: var(--card-2);
      border-radius: 6px;
      margin: 20px 0;
      overflow: hidden;
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      background: var(--primary);
      transition: .3s;
    }

    /* =========================================
   QUESTION CARD
========================================= */

    .card {
      background: var(--card);
      padding: 28px;
      border-radius: 14px;
      border: 1px solid var(--card-2);
      box-shadow: var(--shadow);
    }

    .card h2 {
      margin-bottom: 18px;
    }

    /* options */

    .option {
      display: block;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      background: var(--card-2);
      cursor: pointer;
      transition: .2s;
    }

    .option:hover {
      transform: translateX(4px);
      background: var(--primary);
      color: var(--bg);
    }

    /* navigation */

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .submit-wrap {
      text-align: center;
      margin-top: 25px;
    }


    /* =========================================
   ðŸ“± MOBILE ONLY â€“ move question numbers below submit
   ========================================= */

    @media (max-width: 768px) {

      /* stack layout vertically */
      .layout {
        flex-direction: column;
      }

      /* make main appear first */
      .main {
        order: 1;
        padding: 20px;
      }

      /* move sidebar AFTER main */
      .sidebar {
        order: 2;
        width: 100%;
        border-right: none;
        border-top: 1px solid var(--card-2);
        margin-top: 20px;
      }

      /* nicer mobile spacing */
      .q-grid {
        grid-template-columns: repeat(5, 1fr);
      }

    }
  </style>
</head>


<body data-protected>

  <div class="layout">

    <!-- SIDEBAR -->
    <div class="sidebar">
      <h3>Questions</h3>
      <div id="qGrid" class="q-grid"></div>
    </div>


    <!-- MAIN -->
    <div class="main">

      <div class="topbar">
        <div class="brand">ðŸŽ“ StudentHub</div>

        <div class="right-controls">
          <button id="pauseBtn" class="btn btn-accent">Pause</button>
          <div id="timer" class="timer">00:00</div>
        </div>
      </div>

      <div class="progress">
        <div id="progressBar" class="progress-inner"></div>
      </div>

      <div id="questionBox"></div>

      <div class="submit-wrap">
        <button id="submitBtn" class="btn btn-primary">Submit Quiz</button>
      </div>

    </div>
  </div>



  <!-- ================= JS (UNCHANGED LOGIC) ================= -->

  <script>
    /* =====================================================
       STUDENTHUB â€” QUIZ ATTEMPT (PRO FINAL SAFE VERSION)
       Fixed answers + timer + storage + stability
    ===================================================== */

    const quizId = new URLSearchParams(location.search).get("quizId");

    const questionBox = document.getElementById("questionBox");
    const qGrid = document.getElementById("qGrid");
    const progressBar = document.getElementById("progressBar");
    const timer = document.getElementById("timer");
    const pauseBtn = document.getElementById("pauseBtn");
    const submitBtn = document.getElementById("submitBtn");

    let questions = [];
    let answers = JSON.parse(localStorage.getItem("quizAnswers") || "{}");
    let review = new Set(JSON.parse(localStorage.getItem("quizReview") || "[]"));

    let current = 0;
    let paused = false;
    let submitted = false;
    let timerInterval;


    /* =====================================================
       SAFE STORAGE INIT (no clear)
    ===================================================== */

    const savedQuizId = localStorage.getItem("activeQuizId");

    if (savedQuizId !== quizId) {
      localStorage.removeItem("quizAnswers");
      localStorage.removeItem("quizReview");
      localStorage.removeItem("quizRemaining");
      localStorage.removeItem("quizStartTime");
      localStorage.setItem("activeQuizId", quizId);
    }


    /* =====================================================
       TIMER STATE
    ===================================================== */

    let startTime = localStorage.getItem("quizStartTime");
    if (!startTime) {
      startTime = new Date().toISOString();
      localStorage.setItem("quizStartTime", startTime);
    }

    let remaining = Number(localStorage.getItem("quizRemaining"));


    /* =====================================================
       LOAD QUIZ
    ===================================================== */

    async function loadQuiz() {

      const res = await fetch(`/api/quiz/${quizId}`, { credentials: "include" });
      const data = await res.json();

      questions = data.questions || [];

      if (!questions.length) {
        questionBox.innerHTML = "<h2>No questions available</h2>";
        return;
      }

      /* FIX: only set timer first time */
      if (!remaining || remaining <= 0) {
        remaining = questions.length * 60;
      }

      createSidebar();
      showQuestion(0);
      startTimer();
    }


    /* =====================================================
       SIDEBAR
    ===================================================== */

    function createSidebar() {
      qGrid.innerHTML = "";

      questions.forEach((_, i) => {
        const b = document.createElement("button");
        b.className = "q-btn";
        b.textContent = i + 1;
        b.onclick = () => showQuestion(i);
        qGrid.appendChild(b);
      });
    }

    function updateSidebar() {

      document.querySelectorAll(".q-btn").forEach((b, i) => {

        const qid = questions[i]._id;

        b.className = "q-btn";

        if (i === current) b.classList.add("active");
        if (answers.hasOwnProperty(qid)) b.classList.add("answered");
        if (review.has(i)) b.classList.add("review");

      });
    }


    /* =====================================================
       QUESTION RENDER
    ===================================================== */

    function showQuestion(i) {

      current = i;

      const q = questions[i];
      const selected = answers[q._id];

      questionBox.innerHTML = `
    <div class="card">
      <h2>Q${i + 1}. ${q.questionText}</h2>

      ${q.options.map((o, idx) => `
        <label class="option">
          <input type="radio" name="opt" value="${idx}" ${selected == idx ? "checked" : ""}/>
          ${o}
        </label>
      `).join("")}

      <div class="nav-buttons">
        <button class="btn btn-primary" onclick="prev()">Prev</button>
        <button class="btn btn-danger" onclick="markReview()">Review</button>
        <button class="btn btn-primary" onclick="next()">Next</button>
      </div>
    </div>
  `;

      /* â­ FIX: SAVE INDEX, NOT TEXT */
      document.querySelectorAll("input[type=radio]").forEach(r => {
        r.onchange = () => {
          answers[q._id] = Number(r.value);
          localStorage.setItem("quizAnswers", JSON.stringify(answers));
          updateSidebar();
          updateProgress();
        };
      });

      updateSidebar();
      updateProgress();
    }


    /* =====================================================
       NAVIGATION
    ===================================================== */

    function next() {
      if (current < questions.length - 1) showQuestion(current + 1);
    }

    function prev() {
      if (current > 0) showQuestion(current - 1);
    }

    function markReview() {
      review.add(current);
      localStorage.setItem("quizReview", JSON.stringify([...review]));
      updateSidebar();
    }


    /* =====================================================
       TIMER
    ===================================================== */

    function startTimer() {

      timerInterval = setInterval(() => {

        if (paused || submitted) return;

        remaining--;
        localStorage.setItem("quizRemaining", remaining);

        const m = Math.floor(remaining / 60);
        const s = remaining % 60;

        timer.textContent =
          `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

        if (remaining <= 60) timer.classList.add("danger");

        if (remaining <= 0) submitQuiz(true);

      }, 1000);
    }

    pauseBtn.onclick = () => {
      paused = !paused;
      pauseBtn.textContent = paused ? "Resume" : "Pause";
    };


    /* =====================================================
       PROGRESS
    ===================================================== */

    function updateProgress() {
      progressBar.style.width =
        (Object.keys(answers).length / questions.length) * 100 + "%";
    }


    /* =====================================================
       SUBMIT
    ===================================================== */

    async function submitQuiz(auto = false) {

      if (submitted) return;
      if (!auto && !confirm("Submit quiz now?")) return;

      submitted = true;
      clearInterval(timerInterval);

      const res = await fetch(`/api/quiz/${quizId}/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          answers,
          timeTaken: (questions.length * 60) - remaining
        })
      });

      const result = await res.json();

      /* clean attempt cache only */
      localStorage.removeItem("quizAnswers");
      localStorage.removeItem("quizReview");
      localStorage.removeItem("quizRemaining");
      localStorage.removeItem("quizStartTime");
      localStorage.removeItem("activeQuizId");

      location.href = `/quiz-result.html?attemptId=${result.attemptId}`;
    }

    submitBtn.onclick = () => submitQuiz(false);


    /* =====================================================
       INIT
    ===================================================== */

    loadQuiz();

    window.onbeforeunload = () =>
      submitted ? null : "Your progress will be lost!";

    window.scrollTo(0, 0);
  </script>

  <!-- THEME -->
  <script src="/js/guard.js"></script>
  <script src="/script.js"></script>


</body>

</html>