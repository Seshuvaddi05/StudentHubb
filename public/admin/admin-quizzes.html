<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>StudentHub Admin | All Quizzes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- GLOBAL -->
    <link rel="stylesheet" href="/styles/styles.css" />
    <link rel="stylesheet" href="/admin/admin-quizzes.css" />

    <meta name="theme-color" content="#0f172a" />
</head>

<body>

<!-- ================= NAVBAR ================= -->
<nav class="admin-navbar">
    <div class="admin-navbar-inner">

        <div class="admin-brand">StudentHub Admin</div>

        <div class="admin-nav">
            <a href="/admin.html">Upload</a>
            <a href="/admin-materials.html">Materials</a>
            <a href="/admin-submissions.html">Submissions</a>
            <a href="/admin-approved.html">Approved</a>
            <a href="/admin-withdrawals.html">Withdrawals</a>
            <a href="/admin-requests.html">Requests</a>
            <a href="/admin/admin-quiz.html">Create Quiz</a>
            <a href="/admin/admin-quizzes.html" class="active">All Quizzes</a>
        </div>

        <div class="admin-actions">
            <a href="/" target="_blank" class="admin-view-link">View site</a>
            <!-- âœ… correct id -->
            <button class="theme-toggle-btn" id="theme-toggle">ðŸŒ™</button>

            <!--<button id="theme-toggle" class="theme-toggle-btn">ðŸŒ™</button>-->
        </div>

    </div>
</nav>



<!-- ================= PAGE ================= -->
<main class="admin-page">
    <div class="admin-container">

        <div class="admin-card">

            <h1>All Quizzes</h1>
            <p class="muted">Manage manual & AI quizzes</p>

            <!-- FILTER BAR -->
            <div class="quiz-toolbar">
                <input id="searchInput" placeholder="ðŸ” Search title..." />
                <select id="topicFilter">
                    <option value="">All Topics</option>
                    <option value="quantitative">Quantitative</option>
                    <option value="reasoning">Reasoning</option>
                    <option value="gk">GK</option>
                    <option value="programming">Programming</option>
                </select>

                <select id="typeFilter">
                    <option value="">All Types</option>
                    <option value="manual">Manual</option>
                    <option value="ai">AI</option>
                </select>

                <select id="statusFilter">
                    <option value="">All Status</option>
                    <option value="true">Active</option>
                    <option value="false">Disabled</option>
                </select>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper">
                <table class="quiz-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Topic</th>
                            <th>Type</th>
                            <th>Questions</th>
                            <th>Status</th>
                            <th>Actions</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="quizTableBody"></tbody>
                </table>
            </div>

        </div>
    </div>
</main>



<!-- ================= SCRIPT ================= -->
<script>
const tbody = document.getElementById("quizTableBody");
const searchInput = document.getElementById("searchInput");
const topicFilter = document.getElementById("topicFilter");
const typeFilter = document.getElementById("typeFilter");
const statusFilter = document.getElementById("statusFilter");

let quizzes = [];


/* ========= helpers ========= */
function escapeHTML(str="") {
    return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
}

function showMessage(text){
    tbody.innerHTML =
        `<tr><td colspan="7" class="table-empty">${text}</td></tr>`;
}


/* ========= load ========= */
async function loadQuizzes() {
    try {
        showMessage("Loading quizzes...");

        const res = await fetch("/api/admin/quiz/all", { credentials: "include" });
        const data = await res.json();

        quizzes = data.quizzes || [];
        render();

    } catch {
        showMessage("Failed to load quizzes");
    }
}


/* ========= render ========= */
function render() {

    const search = (searchInput.value || "").toLowerCase();
    const topic = topicFilter.value;
    const type = typeFilter.value;
    const status = statusFilter.value;

    const filtered = quizzes.filter(q => {
        if (search && !q.title.toLowerCase().includes(search)) return false;
        if (topic && q.topic !== topic) return false;
        if (type && q.type !== type) return false;
        if (status && String(q.isActive) !== status) return false;
        return true;
    });

    if (!filtered.length) {
        showMessage("No quizzes found");
        return;
    }

    tbody.innerHTML = "";

    filtered.forEach(q => {

        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${escapeHTML(q.title)}</td>
            <td>${escapeHTML(q.topic)}</td>
            <td>${q.type}</td>
            <td>${q.totalQuestions}</td>
            <td>
                <span class="status-badge ${q.isActive ? "status-active" : "status-inactive"}">
                    ${q.isActive ? "Active" : "Disabled"}
                </span>
            </td>
            <td>
                <button class="action-btn ${q.isActive ? "btn-disable" : "btn-enable"}">
                    ${q.isActive ? "Disable" : "Enable"}
                </button>
                <button class="action-btn btn-delete">Delete</button>
            </td>
            <td>${new Date(q.createdAt).toLocaleString()}</td>
        `;

        tr.querySelector(".btn-disable, .btn-enable")
            .addEventListener("click", () => toggleQuiz(q.id));

        tr.querySelector(".btn-delete")
            .addEventListener("click", () => deleteQuiz(q.id));

        tbody.appendChild(tr);
    });
}


/* ========= actions ========= */
async function toggleQuiz(id) {
    await fetch(`/api/admin/quiz/${id}/toggle`, {
        method: "PUT",
        credentials: "include"
    });
    loadQuizzes();
}

async function deleteQuiz(id) {
    if (!confirm("Delete this quiz permanently?")) return;

    await fetch(`/api/admin/quiz/${id}`, {
        method: "DELETE",
        credentials: "include"
    });
    loadQuizzes();
}


/* ========= events ========= */
searchInput.oninput = render;
topicFilter.onchange = render;
typeFilter.onchange = render;
statusFilter.onchange = render;

loadQuizzes();
</script>

<!-- GLOBAL THEME -->
<script src="/admin-theme.js"></script>

</body>
</html>
